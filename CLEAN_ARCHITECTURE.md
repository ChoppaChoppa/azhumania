# Clean Architecture для Azhumania

## Обзор

Проект Azhumania был рефакторен согласно принципам Clean Architecture и Clean Code. Новая архитектура обеспечивает:

- **Читаемость кода** - четкое разделение ответственности
- **Тестируемость** - изоляция бизнес-логики от внешних зависимостей
- **Поддерживаемость** - легкое внесение изменений
- **Расширяемость** - простое добавление новых функций

## Структура архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                        PRESENTATION LAYER                   │
├─────────────────────────────────────────────────────────────┤
│  cmd/main.go                                                │
│  └── Точка входа в приложение                              │
│      ├── Инициализация зависимостей                        │
│      ├── Dependency Injection                              │
│      └── Запуск приложения                                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        BOT LAYER                            │
├─────────────────────────────────────────────────────────────┤
│  internal/bot/telegram/                                     │
│  ├── server.go                                              │
│  │   ├── TelegramBot struct                                │
│  │   └── Интеграция с Telegram API                         │
│  └── listen.go                                              │
│      └── Обработка входящих сообщений                      │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    APPLICATION LAYER                        │
├─────────────────────────────────────────────────────────────┤
│  internal/application/                                       │
│  ├── handlers/                                              │
│  │   ├── message_handler.go                                 │
│  │   │   ├── MessageHandler - основной обработчик          │
│  │   │   ├── Валидация входных данных                      │
│  │   │   └── Маршрутизация команд                          │
│  │   └── command_handler.go                                 │
│  │       ├── CommandHandler - обработка команд             │
│  │       ├── /start, /help, /stats                         │
│  │       └── Форматирование ответов                        │
│  └── services/                                              │
│      ├── user_service.go                                    │
│      │   ├── UserService - бизнес-логика пользователей     │
│      │   ├── GetOrCreateUser                               │
│      │   └── UpdateUserNickname                            │
│      └── pushup_service.go                                  │
│          ├── PushupService - бизнес-логика отжиманий       │
│          ├── AddPushupApproach                             │
│          └── GetTodayStats                                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                       DOMAIN LAYER                          │
├─────────────────────────────────────────────────────────────┤
│  internal/domain/                                            │
│  ├── models/                                                │
│  │   ├── user.go                                            │
│  │   │   ├── User - доменная модель                         │
│  │   │   ├── IsValid() - валидация                          │
│  │   │   └── UpdateNickname() - бизнес-методы               │
│  │   ├── pushup_session.go                                  │
│  │   │   ├── PushupSession - сессия отжиманий               │
│  │   │   ├── PushupApproach - подход отжиманий              │
│  │   │   ├── AddApproach() - добавление подхода             │
│  │   │   └── GetTotalCount() - подсчет статистики           │
│  │   └── statistics.go                                      │
│  │       ├── WeeklyStats - статистика за неделю             │
│  │       └── MonthlyStats - статистика за месяц             │
│  ├── repositories/                                          │
│  │   ├── user_repository.go                                 │
│  │   │   └── UserRepository interface                       │
│  │   └── pushup_repository.go                               │
│  │       └── PushupRepository interface                     │
│  └── errors/                                                │
│      └── errors.go                                          │
│          └── Доменные ошибки                                │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                   INFRASTRUCTURE LAYER                      │
├─────────────────────────────────────────────────────────────┤
│  internal/infrastructure/                                    │
│  └── repositories/                                          │
│      ├── user_repository_adapter.go                         │
│      │   ├── UserRepositoryAdapter                          │
│      │   ├── Адаптация к существующим репозиториям          │
│      │   └── Кэширование + БД                              │
│      └── pushup_repository_adapter.go                       │
│          ├── PushupRepositoryAdapter                        │
│          ├── Адаптация к существующим репозиториям          │
│          └── Кэширование + БД                              │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      DATA LAYER                             │
├─────────────────────────────────────────────────────────────┤
│  internal/repository/                                        │
│  ├── database/psql/                                         │
│  │   ├── repository.go                                      │
│  │   ├── users.go                                           │
│  │   └── azhumania.go                                       │
│  └── cache/redis/                                           │
│      ├── cache.go                                           │
│      ├── users.go                                           │
│      └── azhumania.go                                       │
└─────────────────────────────────────────────────────────────┘
```

## Принципы Clean Architecture

### 1. **Dependency Rule**
Зависимости направлены внутрь. Внешние слои зависят от внутренних, но не наоборот.

### 2. **Separation of Concerns**
Каждый слой имеет четкую ответственность:
- **Domain** - бизнес-правила и модели
- **Application** - use cases и координация
- **Infrastructure** - технические детали
- **Presentation** - пользовательский интерфейс

### 3. **Dependency Inversion**
Высокоуровневые модули не зависят от низкоуровневых. Оба зависят от абстракций.

## Ключевые улучшения

### 1. **Доменные модели с бизнес-логикой**
```go
// internal/domain/models/user.go
type User struct {
    ID         int64
    Phone      string
    NickName   string
    TelegramID int64
    CreatedAt  time.Time
    UpdatedAt  time.Time
}

func (u *User) IsValid() error {
    if u.Phone == "" {
        return errors.ErrInvalidPhone
    }
    // ... другие проверки
}
```

### 2. **Сервисы с четкой ответственностью**
```go
// internal/application/services/user_service.go
type UserService struct {
    userRepo repositories.UserRepository
}

func (s *UserService) GetOrCreateUser(ctx context.Context, telegramID int64, phone, nickname string) (*models.User, error) {
    // Бизнес-логика создания/получения пользователя
}
```

### 3. **Обработчики с единой ответственностью**
```go
// internal/application/handlers/message_handler.go
type MessageHandler struct {
    userService    *services.UserService
    pushupService  *services.PushupService
    commandHandler *CommandHandler
    logger         zerolog.Logger
}
```

### 4. **Адаптеры для интеграции**
```go
// internal/infrastructure/repositories/user_repository_adapter.go
type UserRepositoryAdapter struct {
    db     psql.IDatabase
    cache  redis.ICache
    logger zerolog.Logger
}
```

## Преимущества новой архитектуры

### 1. **Тестируемость**
- Бизнес-логика изолирована от внешних зависимостей
- Легко создавать моки для тестирования
- Unit-тесты для каждого слоя

### 2. **Читаемость**
- Четкое разделение ответственности
- Понятные имена функций и переменных
- Документированный код

### 3. **Поддерживаемость**
- Изменения в одном слое не влияют на другие
- Легко добавлять новые функции
- Простое рефакторинг

### 4. **Расширяемость**
- Легко добавлять новые команды
- Простое подключение новых источников данных
- Гибкая архитектура

## Примеры использования

### Добавление новой команды
1. Добавить обработку в `CommandHandler`
2. Добавить бизнес-логику в соответствующий сервис
3. Обновить доменные модели при необходимости

### Добавление нового источника данных
1. Создать новый адаптер в `infrastructure/repositories`
2. Реализовать интерфейс из `domain/repositories`
3. Обновить DI в `service.go`

## TODO для дальнейшего развития

1. **Добавить тесты** для всех слоев
2. **Реализовать статистику** за неделю/месяц
3. **Добавить валидацию** входных данных
4. **Реализовать кэширование** с TTL
5. **Добавить метрики** и мониторинг
6. **Реализовать миграции** БД
7. **Добавить конфигурацию** через env переменные

## Заключение

Новая архитектура обеспечивает:
- **Высокое качество кода** согласно принципам Clean Code
- **Легкость тестирования** и поддержки
- **Простоту расширения** функциональности
- **Четкое разделение** ответственности между слоями

Код стал более читаемым, тестируемым и поддерживаемым, что соответствует лучшим практикам разработки на Go.
